services:
  postgres:
    image: postgres:18-alpine
    container_name: nabi-auth-db
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${POSTGRES_DB:-postgres}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - nabi-auth-network

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: nabi-auth-app
    environment:
      HOST: ${HOST:-0.0.0.0:8000}
      PRODUCTION: ${PRODUCTION:-false}
      DATABASE_URL: postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/${POSTGRES_DB:-postgres}?sslmode=disable
      JWT_PRIVATE_KEY_PATH: ${JWT_PRIVATE_KEY_PATH:-./keys/jwt_private.pem}
      JWT_PUBLIC_KEY_PATH: ${JWT_PUBLIC_KEY_PATH:-./keys/jwt_public.pem}
      ACCESS_TOKEN_TTL: ${ACCESS_TOKEN_TTL:-3600}
      REFRESH_TOKEN_TTL: ${REFRESH_TOKEN_TTL:-2592000}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_REDIRECT_URL: ${GOOGLE_REDIRECT_URL:-http://localhost:8000/auth/oauth2/google/callback}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN:-}
      OTP_EXPIRATION: ${OTP_EXPIRATION:-600}
      OTP_MAX_ATTEMPTS: ${OTP_MAX_ATTEMPTS:-5}
    ports:
      - "${APP_PORT:-8000}:8000"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - nabi-auth-network
    restart: unless-stopped

volumes:
  postgres_data:

networks:
  nabi-auth-network:
    driver: bridge

